# å‰ç«¯è°ƒè¯•

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [å‰ç«¯è°ƒè¯•](#å‰ç«¯è°ƒè¯•)
  - [ä¸€. ç”¨ VSCode è°ƒè¯•ç½‘é¡µ](#ä¸€-ç”¨-vscode-è°ƒè¯•ç½‘é¡µ)
    - [1.1 VSCode Chrome Debugger é…ç½®è¯¦è§£](#11-vscode-chrome-debugger-é…ç½®è¯¦è§£)
  - [äºŒ. ç”¨ VSCode Debugger è°ƒè¯• Node.js](#äºŒ-ç”¨-vscode-debugger-è°ƒè¯•-nodejs)
  - [ä¸‰. ç”¨ Chrome DevTools è°ƒè¯•ç½‘é¡µ](#ä¸‰-ç”¨-chrome-devtools-è°ƒè¯•ç½‘é¡µ)
  - [å››. å¸¸ç”¨è°ƒè¯•å·¥å…·åŸç†](#å››-å¸¸ç”¨è°ƒè¯•å·¥å…·åŸç†)
    - [4.1 Chrome DevTools åŸç†](#41-chrome-devtools-åŸç†)
    - [4.2 VSCode Debugger åŸç†](#42-vscode-debugger-åŸç†)
    - [4.3 Vue/React DevTools](#43-vuereact-devtools)
    - [4.4 è°ƒè¯•å·¥å…·å››è¦ç´ ](#44-è°ƒè¯•å·¥å…·å››è¦ç´ )
    - [4.5 sourcemap](#45-sourcemap)
      - [4.5.1 ä»€ä¹ˆæ˜¯ sourcemap](#451-ä»€ä¹ˆæ˜¯-sourcemap)
      - [4.5.2 sourcemap çš„ç”Ÿæˆ](#452-sourcemap-çš„ç”Ÿæˆ)
      - [4.5.3 webpack çš„ sourcemap é…ç½®](#453-webpack-çš„-sourcemap-é…ç½®)

<!-- /code_chunk_output -->

ä»£ç åœ¨æŸä¸ªå¹³å°è¿è¡Œï¼ŒæŠŠè¿è¡Œæ—¶çš„çŠ¶æ€é€šè¿‡æŸç§æ–¹å¼æš´éœ²å‡ºæ¥ï¼Œä¼ é€’ç»™å¼€å‘å·¥å…·åš UI çš„å±•ç¤ºå’Œäº¤äº’ï¼Œè¾…åŠ©å¼€å‘è€…æ’æŸ¥é—®é¢˜ã€æ¢³ç†æµç¨‹ã€äº†è§£ä»£ç è¿è¡ŒçŠ¶æ€ç­‰ï¼Œè¿™ä¸ªå°±æ˜¯è°ƒè¯•ã€‚

è¿™é‡Œçš„æŸä¸ªå¹³å°ï¼Œå¯ä»¥æ˜¯æµè§ˆå™¨ã€Node.jsã€Electronã€å°ç¨‹åºç­‰ä»»ä½•èƒ½æ‰§è¡Œ JS ä»£ç çš„å¹³å°ã€‚

æš´éœ²å‡ºçš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œå¯èƒ½æ˜¯è°ƒç”¨æ ˆã€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæˆ–è€… DOM çš„ç»“æ„ï¼ŒReact ç»„ä»¶çš„çŠ¶æ€ç­‰ã€‚

æš´éœ²å‡ºè¿™äº›æ•°æ®çš„æ–¹å¼ä¸€èˆ¬æ˜¯é€šè¿‡åŸºäº WebSocket çš„è°ƒè¯•åè®®ï¼Œå½“ç„¶ä¹Ÿä¼šæœ‰åˆ«çš„æ–¹å¼ã€‚

## ä¸€. ç”¨ VSCode è°ƒè¯•ç½‘é¡µ

### 1.1 VSCode Chrome Debugger é…ç½®è¯¦è§£

- `launch/attach`

  åˆ›å»º Chrome Debug é…ç½®æœ‰ä¸¤ç§æ–¹å¼ï¼šlaunch å’Œ attachï¼Œå®ƒä»¬åªæ˜¯ request çš„é…ç½®ä¸åŒã€‚

  è°ƒè¯•å°±æ˜¯æŠŠæµè§ˆå™¨è·‘èµ·æ¥ï¼Œè®¿é—®ç›®æ ‡ç½‘é¡µï¼Œè¿™æ—¶å€™ä¼šæœ‰ä¸€ä¸ª ws çš„è°ƒè¯•æœåŠ¡ï¼Œç”¨ frontend çš„ ws å®¢æˆ·ç«¯è¿æ¥ä¸Šè¿™ä¸ª ws æœåŠ¡ï¼Œå°±å¯ä»¥è¿›è¡Œè°ƒè¯•äº†ã€‚

  ![è°ƒè¯•åŸç†](./image/%E8%B0%83%E8%AF%95%E5%8E%9F%E7%90%86.webp)

  VSCode çš„ Debugger ä¼šå¤šä¸€å±‚é€‚é…å™¨åè®®çš„è½¬æ¢ï¼Œä½†æ˜¯åŸç†å·®ä¸å¤šã€‚

  launch çš„æ„æ€æ˜¯æŠŠ url å¯¹åº”çš„ç½‘é¡µè·‘èµ·æ¥ï¼ŒæŒ‡å®šè°ƒè¯•ç«¯å£ï¼Œç„¶å frontend è‡ªåŠ¨ attach åˆ°è¿™ä¸ªç«¯å£ã€‚ä½†å¦‚æœå·²ç»æœ‰ä¸€ä¸ªåœ¨è°ƒè¯•æ¨¡å¼è·‘çš„æµè§ˆå™¨äº†ï¼Œé‚£ç›´æ¥è¿æ¥ä¸Šå°±è¡Œï¼Œè¿™æ—¶å€™å°±ç›´æ¥ä½¿ç”¨ attachã€‚

  [ä½¿ç”¨ attach å‰éœ€è¦é¢„å…ˆå®‰è£…æ’ä»¶å’Œè®¾ç½® Chrome](/public_knowledge/VSCode/VisualStudioCode.md#421-web-å¼€å‘åˆ©å™¨)

- `userDataDir`

  user data dir æ˜¯ä¿å­˜ç”¨æˆ·æ•°æ®çš„åœ°æ–¹ï¼Œæ¯”å¦‚æµè§ˆè®°å½•ã€cookiesã€æ’ä»¶ã€ä¹¦ç­¾ã€ç½‘ç«™çš„æ•°æ®ç­‰ã€‚ç”¨æˆ·æ•°æ®ç›®å½•æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯åªèƒ½è¢«ä¸€ä¸ª Chrome å®ä¾‹æ‰€è®¿é—®ï¼Œå¦‚æœä¹‹å‰å¯åŠ¨äº† Chrome ç”¨äº†è¿™ä¸ªé»˜è®¤çš„ user data dirï¼Œé‚£å°±ä¸èƒ½å†å¯åŠ¨ä¸€ä¸ª Chrome å®ä¾‹ç”¨å®ƒäº†ã€‚å¦‚æœç”¨æˆ·æ•°æ®ç›®å½•å·²ç»è·‘äº†ä¸€ä¸ª Chrome å®ä¾‹ï¼Œå†è·‘ä¸€ä¸ªå°±ä¼šæŠ¥é”™ `Unable to attach to browser`ã€‚

  æ‰€ä»¥ç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨ Chrome çš„æ—¶å€™ï¼Œéœ€è¦å•ç‹¬æŒ‡å®šä¸€ä¸‹ user data dir çš„ä½ç½®ã€‚æˆ–è€…æŠŠä¹‹å‰çš„ Chrome å®ä¾‹å…³æ‰ï¼Œè¿™æ ·æ‰èƒ½ç”¨é»˜è®¤çš„ã€‚

  åªèƒ½åœ¨ request ä¸º launch æ¨¡å¼ä¸‹é…ç½®ï¼Œé»˜è®¤ä¸º trueï¼Œä»£è¡¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ä¿å­˜ç”¨æˆ·æ•°æ®ã€‚ä¹Ÿå¯ä»¥è®¾ç½®ä¸º falseï¼Œä½¿ç”¨é»˜è®¤ user data dir å¯åŠ¨ chromeã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯ç™»å½•çŠ¶æ€ã€å†å²è®°å½•éƒ½æœ‰ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„è·¯å¾„ï¼Œè¿™æ ·ç”¨æˆ·æ•°æ®å°±ä¼šä¿å­˜åœ¨é‚£ä¸ªç›®å½•ä¸‹ã€‚

  æ›´é‡è¦çš„æ˜¯ï¼Œå®‰è£…çš„ Vue DevTools ç­‰æ’ä»¶éƒ½æ˜¯åœ¨é»˜è®¤ç”¨æˆ·æ•°æ®ç›®å½•çš„ï¼Œè¦æ˜¯ç”¨ä¸´æ—¶æ•°æ®ç›®å½•è·‘è°ƒè¯•ï¼Œè¿™äº›å°±éƒ½æ²¡äº†ã€‚å½“ `userDataDir` è®¾ç½®ä¸º true çš„æ—¶å€™ï¼ŒVue DevTools æ’ä»¶æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦å†å®‰è£…ï¼ŒuserDataDir è®¾ç½®ä¸º false çš„æ—¶å€™ï¼Œå®‰è£…è¿‡çš„æ’ä»¶éƒ½å¯ä»¥ç›´æ¥ç”¨ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨ä¸‹é¢çš„é…ç½®è§£å†³ã€‚

- `runtimeExecutable`

  è°ƒè¯•ç½‘é¡µçš„ JSï¼Œéœ€è¦å…ˆæŠŠ Chrome è·‘èµ·æ¥ï¼Œé»˜è®¤è·‘çš„æ˜¯ Google Chromeï¼Œå…¶å®å®ƒè¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰ˆæœ¬ Canaryã€‚è¿™æ˜¯ç»™å¼€å‘è€…ç”¨çš„æ¯æ—¥æ„å»ºç‰ˆï¼Œèƒ½å¤Ÿå¿«é€Ÿä½“éªŒæ–°ç‰¹æ€§ï¼Œä½†æ˜¯ä¸ç¨³å®šã€‚å¯ä»¥åœ¨[å®˜ç½‘](https://www.google.com/intl/zh-CN/chrome/canary/)ä¸‹è½½ã€‚ç„¶åæŒ‡å®š `runtimeExecutable` ä¸º canaryï¼Œä½¿ç”¨é»˜è®¤çš„ç”¨æˆ·æ•°æ®ç›®å½•å¯åŠ¨ã€‚è¿™æ ·å°±å¯ä»¥è°ƒè¯•ç”¨ canaryï¼Œå¹³æ—¶ç”¨ chrome äº†ï¼Œä¸¤ç§ä¸å…±ç”¨åŒä¸€ä¸ªæ•°æ®ç›®å½•ã€‚

  å½“ç„¶ï¼ŒruntimeExecutable è¿˜å¯ä»¥æŒ‡å®šç”¨åˆ«çš„æµè§ˆå™¨è·‘ï¼Œå¯ä»¥æ˜¯ stableï¼Œä¹Ÿå°±æ˜¯ç¨³å®šçš„ Google Chromeï¼Œæˆ–è€… canary è¿˜å¯ä»¥æ˜¯ customï¼Œç„¶åç”¨ CHROME_PATH ç¯å¢ƒå˜é‡æŒ‡å®šæµè§ˆå™¨çš„åœ°å€ã€‚

- `runtimeArgs`

  å¯åŠ¨ Chrome çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚æ¯æ¬¡æ‰“å¼€ç½‘é¡µéƒ½é»˜è®¤è°ƒèµ· Chrome DevToolsï¼Œå°±å¯ä»¥åŠ ä¸€ä¸ª `--auto-open-devtools-for-tabs` çš„å¯åŠ¨å‚æ•°ï¼š

  ```json
  {
    "request": "launch",
    "runtimeArgs": ["--auto-open-devtools-for-tabs"]
  }
  ```

  æƒ³è¦æ— ç—•æ¨¡å¼å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ è½½æ’ä»¶ï¼Œæ²¡æœ‰ç™»å½•çŠ¶æ€ï¼Œå°±å¯ä»¥åŠ ä¸€ä¸ª `--incognito` çš„å¯åŠ¨å‚æ•°ã€‚

  å…¶å®è®¾ç½®çš„ userDataDir å°±æ˜¯æŒ‡å®šäº† --user-data-dir çš„å¯åŠ¨å‚æ•°ã€‚

- `sourceMapPathOverrides`

  ä»£ç æ˜¯ç»è¿‡ç¼–è¯‘æ‰“åŒ…ç„¶ååœ¨æµè§ˆå™¨è¿è¡Œçš„ï¼Œä½†è°ƒè¯•æ—¶å´å¯ä»¥ç›´æ¥è°ƒè¯•æºç ï¼Œè¿™æ˜¯é€šè¿‡ sourcemap åšåˆ°çš„ã€‚è°ƒè¯•å·¥å…·éƒ½æ”¯æŒ sourcemapï¼Œå¹¶ä¸”æ˜¯é»˜è®¤å¼€å¯çš„ã€‚å½“ç„¶ä¹Ÿå¯ä»¥å…³æ‰ï¼ŒChrome DevTools é‡Œè¿™ä¹ˆå…³ï¼š

  ![ChromeDevToolså…³é—­sourcemap](./image/ChromeDevTools%E5%85%B3%E9%97%ADsourcemap.webp)

  VSCode Debugger ä¸­å¯ä»¥å°† `sourceMaps` è®¾ä¸º false æ¥å…³é—­ã€‚è¿™æ ·è°ƒè¯•çš„å°±æ˜¯ç¼–è¯‘åçš„ä»£ç äº†ã€‚

  åœ¨å¼€å¯ sourcemap çš„æƒ…å†µä¸‹ï¼Œç”¨ Chrome DevTools å¯ä»¥çœ‹åˆ°ï¼Œæºæ–‡ä»¶çš„è·¯å¾„æ˜¯ /static/js/bundle.jsï¼š

  ![æºæ–‡ä»¶è·¯å¾„](./image/%E6%BA%90%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84.webp)

  è¢« sourcemap åˆ°äº† /Users/guang/code/test-react-debug/src/index.jsï¼š

  ![æºç è·¯å¾„](./image/%E6%BA%90%E7%A0%81%E8%B7%AF%E5%BE%84.webp)

  è€Œåœ¨ VSCode é‡Œï¼Œè¿™ä¸ªè·¯å¾„æ˜¯æœ‰å¯¹åº”çš„æ–‡ä»¶çš„ï¼Œæ‰€ä»¥å°±ä¼šæ‰“å¼€å¯¹åº”æ–‡ä»¶çš„ç¼–è¾‘å™¨ï¼Œè¿™æ ·å°±å¯ä»¥è¾¹è°ƒè¯•è¾¹ä¿®æ”¹ä»£ç ã€‚ä½†æœ‰çš„æ—¶å€™ï¼Œsourcemap åˆ°çš„æ–‡ä»¶è·¯å¾„åœ¨æœ¬åœ°é‡Œæ‰¾ä¸åˆ°ï¼Œè¿™æ—¶å€™ä»£ç å°±åªè¯»äº†ï¼Œå› ä¸ºæ²¡æœ‰åœ°æ–¹ä¿å­˜ã€‚è¿™ç§æƒ…å†µå°±éœ€è¦é€šè¿‡ `sourceMapPathOverrides` å¯¹ sourcemap åˆ°çš„è·¯å¾„å†åšä¸€æ¬¡æ˜ å°„ï¼š

  ![sourcemapæ˜ å°„](./image/sourcemap%E6%98%A0%E5%B0%84.webp)

  é»˜è®¤æœ‰è¿™ä¹ˆä¸‰ä¸ªé…ç½®ï¼š

  ```json
  {
    "sourceMapPathOverrides": {
      "meteor://ğŸ’»app/*": "${workspaceFolder}/*",
      "webpack:///./~/*": "${workspaceFolder}/node_modules/*",
      "webpack://?:*/*": "${workspaceFolder}/*"
    }
  }
  ```

  åˆ†åˆ«æ˜¯æŠŠ meteorã€webpack å¼€å¤´çš„ path æ˜ å°„åˆ°äº†æœ¬åœ°çš„ç›®å½•ä¸‹ã€‚å…¶ä¸­ `?:*` ä»£è¡¨åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œä½†ä¸æ˜ å°„ï¼Œè€Œ `*` æ˜¯ç”¨äºåŒ¹é…å­—ç¬¦å¹¶æ˜ å°„çš„ã€‚

- `file`

  é™¤äº†å¯åŠ¨å¼€å‘æœåŠ¡å™¨ç„¶åè¿ä¸Š url è°ƒè¯•ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šæŸä¸ªæ–‡ä»¶ï¼ŒVSCode Debugger ä¼šå¯åŠ¨é™æ€æœåŠ¡å™¨æä¾›æœåŠ¡ï¼š

  ```json
  {
    "name": "Launch Chrome",
    "request": "launch",
    "type": "pwa-chrome",
    "file": "${workspaceFolder}/index.html",
    "webRoot": "${workspaceFolder}"
  }
  ```

  åŒæ ·ï¼Œè¦ä¿®æ”¹è°ƒè¯•çš„å†…å®¹éœ€è¦æŠŠ url æ˜ å°„åˆ°æœ¬åœ°æ–‡ä»¶æ‰è¡Œï¼Œæ‰€ä»¥æœ‰è¿™æ ·ä¸€ä¸ª `pathMapping` çš„é…ç½®ï¼š

  ```json
  {
    "pathMapping": {
      "/static/js/": "${workspaceFolder}/src/"
    }
  }
  ```

  webRoot å…¶å®å°±ç›¸å½“äºæŠŠ `/` çš„ url æ˜ å°„åˆ°äº† `${workspaceFolder}/`ã€‚

### 1.2 VSCode Chrome Debugger æ–­ç‚¹æ˜ å°„çš„åŸç†

VSCode ä¼šè®°å½•åœ¨å“ªä¸ªæ–‡ä»¶å“ªè¡Œæ‰“äº†ä¸ª[æ–­ç‚¹](/public_knowledge/VSCode/VisualStudioCode.md#355-æ–­ç‚¹çš„ä½¿ç”¨)ã€‚åœ¨ breakpoints é‡Œå¯ä»¥çœ‹åˆ°ã€‚

ä»£ç ç»è¿‡ç¼–è¯‘æ‰“åŒ…ä¹‹åï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ª bundle.jsï¼Œç½‘é¡µé‡Œè¿è¡Œçš„å°±æ˜¯è¿™ä¸ª js æ–‡ä»¶ã€‚æ–­ç‚¹æœ€ç»ˆè¿˜æ˜¯åœ¨ä»£ç çš„è¿è¡Œæ—¶ï¼Œä¹Ÿå°±æ˜¯ç½‘é¡µé‡Œæ–­ä½çš„ï¼Œæ‰€ä»¥åœ¨ VSCode é‡Œæ‰“çš„æ–­ç‚¹ä¼šè¢«ä¼ é€’ç»™æµè§ˆå™¨ï¼Œé€šè¿‡ CDP è°ƒè¯•åè®®ã€‚

æœ¬åœ°æ‰“çš„æ–­ç‚¹æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯åŒ…å« ${workspaceFolder} çš„è·¯å¾„ï¼Œè€Œç½‘é¡µé‡Œæ ¹æœ¬æ²¡æœ‰è¿™ä¸ªè·¯å¾„ï¼Œå¯ä»¥æˆåŠŸæ˜¯å› ä¸ºæœ‰çš„æ–‡ä»¶æ˜¯å…³è”äº† sourcemapï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶æœ«å°¾çš„è¿™è¡Œæ³¨é‡Šï¼š

![å…³è”sourcemap](./image/%E5%85%B3%E8%81%94sourcemap.webp)

å®ƒä¼šæŠŠæ–‡ä»¶è·¯å¾„æ˜ å°„åˆ°æºç è·¯å¾„ã€‚å¦‚æœæ˜ å°„åˆ°çš„æºç è·¯å¾„ç›´æ¥å°±æ˜¯æœ¬åœ°çš„æ–‡ä»¶è·¯å¾„ï¼Œé‚£æ–­ç‚¹å°±ç”Ÿæ•ˆäº†ï¼š

![æ–­ç‚¹æ˜ å°„åŸç†](./image/%E6%96%AD%E7%82%B9%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86.webp)

vite çš„é¡¹ç›®ï¼Œsourcemap éƒ½æ˜¯è¿™ç§ç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥æ–­ç‚¹ç›´æ¥å°±ç”Ÿæ•ˆäº†ï¼š

![viteçš„sourcemap](./image/vite%E7%9A%84sourcemap.webp)

ä½†æ˜¯ webpack çš„é¡¹ç›®ï¼Œsourcemap åˆ°çš„è·¯å¾„ä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œè€Œæ˜¯è¿™ç§ï¼š

![webpack4çš„sourcemap](./image/webpack4%E7%9A%84sourcemap.webp)

æˆ–

![webpack5çš„sourcemap](./image/webpack5%E7%9A%84sourcemap.webp)

æ‰€ä»¥ VSCode Chrome Debugger æ”¯æŒäº† `sourceMapPathOverrides` çš„é…ç½®ï¼š

```json
{
  "sourceMapPathOverrides": {
    "meteor://ğŸ’»app/*": "${workspaceFolder}/*",
    "webpack:///./~/*": "${workspaceFolder}/node_modules/*",
    "webpack://?:*/*": "${workspaceFolder}/*"
  }
}
```

é»˜è®¤ç”Ÿæˆçš„ä¸‰ä¸ªé…ç½®ï¼Œæœ€åä¸€ä¸ªå°±æ˜¯æ˜ å°„ webpack è·¯å¾„çš„ï¼Œå…¶å®æ˜¯æŠŠä»¥ `${workspaceFolder}` å¼€å¤´çš„æœ¬åœ°è·¯å¾„æ˜ å°„æˆäº† webpack:// å¼€å¤´çš„è·¯å¾„ä¼ ç»™æµè§ˆå™¨ã€‚

![sourceMapPathOverridesæ˜ å°„](./image/sourceMapPathOverrides%E6%98%A0%E5%B0%84.webp)

è¿™æ ·å°±å’Œæµè§ˆå™¨é‡Œçš„ sourcemap åçš„æ–‡ä»¶è·¯å¾„å¯¹ä¸Šäº†ï¼Œé‚£æ–­ç‚¹ä¹Ÿå°±ç”Ÿæ•ˆäº†ã€‚

![æœ‰sourceMapPathOverridesçš„æ˜ å°„åŸç†](./image/%E6%9C%89sourceMapPathOverrides%E7%9A%84%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86.webp)

å…·ä½“æ€ä¹ˆé…ï¼Œå¯ä»¥åŠ ä¸ª debugger çœ‹çœ‹ Chrome DevTools é‡Œæ˜¯ä»€ä¹ˆè·¯å¾„ï¼Œç„¶åæ˜ å°„åˆ°æœ¬åœ°çš„è·¯å¾„å°±è¡Œã€‚

ä½†ä¸Šé¢éƒ½æ˜¯æŠŠé¡¹ç›®æ ¹ç›®å½•æ˜ å°„åˆ° url çš„ / çš„ï¼Œæœ‰çš„æ—¶å€™æ˜ å°„çš„ä¸æ˜¯ /ï¼Œä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š

```txt
mobile/js/webpack:/src/pages/user-center/index.tsx
```

è¿™å°±éœ€è¦ webRoot çš„é…ç½®äº†ï¼Œé»˜è®¤æ˜¯ `${workspaceFolder}`ï¼Œä¹Ÿå°±æ˜¯æŠŠé¡¹ç›®æ ¹ç›®å½•æ˜ å°„åˆ° url çš„ /ã€‚å¦‚æœå‡ºç°ä¸Šé¢çš„æƒ…å†µï¼Œè¯´æ˜è¦æŠŠ /mobile/js/ è¿™ä¸ªè·¯å¾„æ˜ å°„åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼š

```json
{
  "webRoot": "${workspaceFolder}/mobile/js/"
}
```

ç»¼ä¸Šï¼Œ**å¦‚æœ sourcemap åˆ°çš„æ–‡ä»¶è·¯å¾„ä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼Œé‚£å°±æ˜ å°„ä¸åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œä¼šå¯¼è‡´æ–­ç‚¹æ‰“ä¸ä¸Šï¼Œè¿™æ—¶å€™å¯ä»¥é…ç½® sourceMapPathOverridesã€‚å¦‚æœæ˜ å°„ä¹‹åè·¯å¾„å¼€å¤´å¤šäº†å‡ å±‚ç›®å½•ï¼Œé‚£å°±è¦é…ç½® webRoot**ã€‚

## äºŒ. ç”¨ VSCode Debugger è°ƒè¯• Node.js

## ä¸‰. ç”¨ Chrome DevTools è°ƒè¯•ç½‘é¡µ

## å››. å¸¸ç”¨è°ƒè¯•å·¥å…·åŸç†

### 4.1 Chrome DevTools åŸç†

Chrome DevTools åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- **backend**ï¼šbackend å’Œ Chrome é›†æˆï¼Œè´Ÿè´£æŠŠ Chrome çš„ç½‘é¡µè¿è¡Œæ—¶çŠ¶æ€é€šè¿‡è°ƒè¯•åè®®æš´éœ²å‡ºæ¥ã€‚backend å¯ä»¥æ˜¯ Chromiumï¼Œä¹Ÿå¯ä»¥æ˜¯ Node.js æˆ–è€… V8ï¼Œè¿™äº› JS çš„è¿è¡Œæ—¶éƒ½æ”¯æŒ CDP è°ƒè¯•åè®®ã€‚

- **frontend**ï¼šfrontend æ˜¯ç‹¬ç«‹çš„ï¼Œè´Ÿè´£å¯¹æ¥è°ƒè¯•åè®®ï¼Œåš UI çš„å±•ç¤ºå’Œäº¤äº’ã€‚

ä¸¤è€…ä¹‹é—´çš„è°ƒè¯•åè®®å«åš Chrome DevTools Protocolï¼Œç®€ç§° **CDP**ã€‚

ä¼ è¾“åè®®æ•°æ®çš„æ–¹å¼å«åš**ä¿¡é“**ï¼ˆmessage channelï¼‰ï¼Œæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ Chrome DevTools åµŒå…¥åœ¨ Chrome é‡Œæ—¶ï¼Œä¸¤è€…é€šè¿‡å…¨å±€çš„å‡½æ•°é€šä¿¡ï¼›å½“ Chrome DevTools è¿œç¨‹è°ƒè¯•æŸä¸ªç›®æ ‡çš„ä»£ç æ—¶ï¼Œä¸¤è€…é€šè¿‡ WebSocket é€šä¿¡ã€‚

![ChromeDevToolsè°ƒè¯•åŸç†](./image/ChromeDevTools%E8%B0%83%E8%AF%95%E5%8E%9F%E7%90%86.webp)

### 4.2 VSCode Debugger åŸç†

VSCode Debugger çš„åŸç†å’Œ Chrome DevTools å·®ä¸å¤šï¼Œä¹Ÿæ˜¯åˆ†ä¸º frontendã€backendã€è°ƒè¯•åè®®è¿™å‡ éƒ¨åˆ†ï¼Œåªä¸è¿‡å®ƒå¤šäº†ä¸€å±‚é€‚é…å™¨åè®®ã€‚

![VSCodeDebuggeråŸç†](./image/VSCodeDebugger%E5%8E%9F%E7%90%86.webp)

ä¸ºäº†èƒ½ç›´æ¥ç”¨ Chrome DevTools è°ƒè¯• Node.js ä»£ç ï¼ŒNode.js 6 ä»¥ä¸Šå°±ä½¿ç”¨ CDP ä½œä¸ºè°ƒè¯•åè®®äº†ï¼Œæ‰€ä»¥ VSCode Debugger è¦è°ƒè¯• Node.js ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªåè®®ã€‚

å› ä¸º VSCode ä¸æ˜¯ JS ä¸“ç”¨ç¼–è¾‘å™¨ï¼Œå®ƒå¯èƒ½ç”¨æ¥è°ƒè¯• Python ä»£ç ã€Rust ä»£ç ç­‰ç­‰ï¼Œä¸èƒ½å’ŒæŸä¸€ç§è¯­è¨€çš„è°ƒè¯•åè®®æ·±åº¦è€¦åˆï¼Œæ‰€ä»¥å¤šäº†ä¸€ä¸ªé€‚é…å™¨å±‚ Debug Adapter Protocolã€‚

![DebugAdapterProtocol](./image/DebugAdapterProtocol.webp)

è¿™æ · VSCode Debugger å°±å¯ä»¥ç”¨åŒä¸€å¥— UI å’Œé€»è¾‘æ¥è°ƒè¯•å„ç§è¯­è¨€çš„ä»£ç ï¼Œåªè¦å¯¹æ¥ä¸åŒçš„ Debug Adapter åšåè®®è½¬æ¢å³å¯ã€‚

è¿™æ ·è¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯åˆ«çš„ç¼–è¾‘å™¨ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ª Debug Adapter Protocol æ¥å®ç°è°ƒè¯•ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥å¤ç”¨ VSCode çš„å„ç§è¯­è¨€çš„ Debug Adapter äº†ã€‚

VSCode Debugger çš„ UI çš„éƒ¨åˆ†ç®—æ˜¯ frontendï¼Œè€Œè°ƒè¯•çš„ç›®æ ‡è¯­è¨€ç®—æ˜¯ backend éƒ¨åˆ†ï¼Œä¸­é—´ä¹Ÿæ˜¯é€šè¿‡ WebSocket ä¼ é€’è°ƒè¯•åè®®ã€‚

æ•´ä½“å’Œ Chrome DevTools çš„è°ƒè¯•åŸç†å·®ä¸å¤šï¼Œåªä¸è¿‡ä¸ºäº†æ”¯æŒ frontend çš„è·¨è¯­è¨€å¤ç”¨ï¼Œå¤šäº†ä¸€å±‚é€‚é…å™¨å±‚ã€‚

### 4.3 Vue/React DevTools

Vue DevTools æˆ–è€… React DevTools éƒ½æ˜¯ä»¥ Chrome æ’ä»¶ï¼ˆChrome Extensionï¼‰çš„å½¢å¼å­˜åœ¨çš„ï¼Œè¦ææ‡‚å®ƒä»¬çš„åŸç†å°±å¾—äº†è§£ Chrome æ’ä»¶çš„æœºåˆ¶ã€‚

**Chrome æ’ä»¶æœºåˆ¶**
Chrome æ’ä»¶ä¸­å¯ä»¥è®¿é—®ç½‘é¡µçš„ DOM çš„éƒ¨åˆ†å«åš **Content Script**ï¼Œéšé¡µé¢å¯åŠ¨è€Œç”Ÿæ•ˆï¼Œå¯ä»¥å†™ä¸€äº›æ“ä½œ DOM çš„é€»è¾‘ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯åå°è¿è¡Œçš„ï¼Œå«åš **Background**ï¼Œæµè§ˆå™¨å¯åŠ¨å°±ç”Ÿæ•ˆäº†ï¼Œç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ï¼Œå¯ä»¥åšä¸€äº›å¸¸é©»çš„é€»è¾‘ã€‚å¦‚æœæ˜¯æ‰©å±• DevTools çš„ Chrome æ’ä»¶ï¼Œé‚£è¿˜æœ‰ä¸€éƒ¨åˆ† DevTools Pageï¼Œæ˜¯åœ¨ DevTools é‡Œæ˜¾ç¤ºçš„é¡µé¢ï¼š

![Chromeæ’ä»¶æœºåˆ¶](./image/Chrome%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6.webp)

Content Script éƒ¨åˆ†å¯ä»¥æ“ä½œ DOMï¼Œå¯ä»¥ç›‘å¬ DOM Eventã€‚

Background éƒ¨åˆ†å¯ä»¥è®¿é—® extension apiï¼Œå¯ä»¥å’Œ Content Script è¿˜æœ‰ DevTools Page é€šä¿¡ã€‚

DevTools Page éƒ¨åˆ†å¯ä»¥è®¿é—® devtools apiï¼Œå¯ä»¥å‘å½“å‰ window æ³¨å…¥ JS æ‰§è¡Œã€‚

è¿™å°±æ˜¯ Chrome æ’ä»¶çš„å¤§æ¦‚æ¶æ„ã€‚Vue DevTools å’Œ React DevTools å°±æ˜¯åŸºäºè¿™ä¸ªæ¶æ„æ¥å®ç°çš„è°ƒè¯•åŠŸèƒ½ã€‚

çœ‹ [Vue DevTools çš„æºç ç›®å½•](https://github.com/vuejs/devtools/tree/main/packages)ä¼šå‘ç°ï¼Œå®ƒä¹Ÿæ˜¯åˆ†ä¸º backend å’Œ frontend çš„

DevTools Page å¯ä»¥å‘é¡µé¢æ³¨å…¥ JS çš„ï¼Œé‚£å°±å¯ä»¥æ³¨å…¥ backend çš„ä»£ç ã€‚backend çš„ä»£ç æ‹¿åˆ° Vue ç»„ä»¶çš„ä¿¡æ¯ï¼Œé€šè¿‡ window message çš„æ–¹å¼ä¼ é€’ç»™ Backgroundã€‚Background å¯ä»¥å’Œ DevTools Page é€šä¿¡ï¼Œä»è€Œå®ç°æ¶ˆæ¯è½¬å‘ã€‚DevTools Page æ ¹æ®æ‹¿åˆ°çš„æ•°æ®ï¼Œæ¸²æŸ“ç»„ä»¶çš„ä¿¡æ¯ï¼Œå®ç°äº¤äº’åŠŸèƒ½ã€‚

![backendå’Œfrontendçš„è¿è¡Œä¸é€šä¿¡](./image/backend%E5%92%8Cfrontend%E7%9A%84%E8%BF%90%E8%A1%8C%E4%B8%8E%E9%80%9A%E4%BF%A1.webp)

### 4.4 è°ƒè¯•å·¥å…·å››è¦ç´ 

Chrome DevToolsã€VSCode Debuggerã€Vue/React DevToolsï¼Œéƒ½æœ‰ backend éƒ¨åˆ†è´Ÿè´£æ‹¿åˆ°è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œæœ‰ frontend éƒ¨åˆ†è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’ï¼Œä¹Ÿæœ‰è°ƒè¯•åè®®ç”¨æ¥è§„å®šä¸åŒæ•°æ®çš„æ ¼å¼ï¼Œè¿˜æœ‰ä¸åŒçš„ä¿¡é“ï¼Œæ¯”å¦‚ WebSocket ã€Chrome æ’ä»¶çš„ background è½¬å‘ç­‰ã€‚

**frontendã€backendã€è°ƒè¯•åè®®ã€ä¿¡é“ï¼Œè¿™æ˜¯è°ƒè¯•å·¥å…·çš„å››è¦ç´ **ã€‚

ä¸è¿‡ï¼Œä¸åŒçš„è°ƒè¯•å·¥å…·éƒ½ä¼šæœ‰ä¸åŒçš„è®¾è®¡ï¼Œæ¯”å¦‚ VSCode Debugger ä¸ºäº†è·¨è¯­è¨€å¤ç”¨ï¼Œå¤šäº†ä¸€å±‚ Debugger Adapterï¼ŒReact DevTools æœ‰ç‹¬ç«‹çš„ electron åº”ç”¨ï¼Œç”¨è‡ªå®šä¹‰è°ƒè¯•åè®®ï¼Œå¯ä»¥è°ƒè¯• React Native ä»£ç ã€‚

### 4.5 sourcemap

#### 4.5.1 ä»€ä¹ˆæ˜¯ sourcemap

**sourcemap æ˜¯é€šè¿‡ä¸€ä¸ªä¸ªè¡Œåˆ—å·çš„æ˜ å°„ï¼Œå…³è”ç¼–è¯‘åçš„ä»£ç å’Œæºç çš„ã€‚**ã€‚

æ¯”å¦‚ç¼–è¯‘åä»£ç çš„ç¬¬ 3 è¡Œç¬¬ 4 åˆ—ï¼Œå¯¹åº”ç€æºç é‡Œçš„ç¬¬ 8 è¡Œç¬¬ 5 åˆ—è¿™ç§ï¼Œè¿™å«åšä¸€ä¸ª **mapping**ã€‚sourcemap çš„æ ¼å¼å¦‚ä¸‹ï¼š

```js
{
ã€€version : 3,
ã€€file: "out.js",
ã€€sourceRoot : "",
ã€€sources: ["foo.js", "bar.js"],
ã€€names: ["a", "b"],
ã€€mappings: "AAgBC,SAAQ,CAAEA;AAAEA",
  sourcesContent: ['const a = 1; console.log(a)', 'const b = 2; console.log(b)']
}
```

file æ˜¯æ–‡ä»¶åï¼ŒsourceRoot æ˜¯æºç æ ¹ç›®å½•ï¼Œnames æ˜¯è½¬æ¢å‰çš„å˜é‡åï¼Œsources æ˜¯æºç æ–‡ä»¶ï¼ŒsourcesContent æ˜¯æ¯ä¸ª sources å¯¹åº”çš„æºç çš„å†…å®¹ï¼Œmappings å°±æ˜¯ä¸€ä¸ªä¸ªä½ç½®æ˜ å°„äº†ã€‚

å› ä¸ºå¯èƒ½ç¼–è¯‘äº§ç‰©æ˜¯å¤šä¸ªæºæ–‡ä»¶åˆå¹¶çš„ï¼Œæ¯”å¦‚æ‰“åŒ…ï¼Œä¸€ä¸ª bundle.js å°±å¯¹åº”äº† n ä¸ª sources æºæ–‡ä»¶ã€‚

**é‡ç‚¹æ˜¯ mappings éƒ¨åˆ†**ï¼šmappings éƒ¨åˆ†æ˜¯é€šè¿‡ `;` å’Œ `,` åˆ†éš”çš„ï¼š

```js
mappings: 'AAAAA,BBBBB;CCCCC';
```

ä¸€ä¸ªåˆ†å·å°±ä»£è¡¨ä¸€è¡Œï¼Œè¿™æ ·å°±å…å»äº†è¡Œçš„æ˜ å°„ã€‚ç„¶åæ¯ä¸€è¡Œå¯èƒ½æœ‰å¤šä¸ªä½ç½®çš„æ˜ å°„ï¼Œç”¨ `,` åˆ†éš”ã€‚

ä¸Šé¢çš„ mappings ä¸­æœ‰ AAAAA ä¸€å…±äº”ä½ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„å«ä¹‰ï¼š

- è½¬æ¢åä»£ç çš„ç¬¬å‡ åˆ—ï¼ˆè¡Œæ•°é€šè¿‡åˆ†å· ; æ¥ç¡®å®šï¼‰
- è½¬æ¢å‰çš„å“ªä¸ªæºç æ–‡ä»¶ï¼Œä¿å­˜åœ¨ sources é‡Œçš„ï¼Œè¿™é‡Œé€šè¿‡ä¸‹æ ‡ç´¢å¼•
- è½¬æ¢å‰çš„æºç çš„ç¬¬å‡ è¡Œ
- è½¬æ¢å‰çš„æºç çš„ç¬¬å‡ åˆ—
- è½¬æ¢å‰çš„æºç çš„å“ªä¸ªå˜é‡åï¼Œä¿å­˜åœ¨ names é‡Œçš„ï¼Œè¿™é‡Œé€šè¿‡ä¸‹æ ‡ç´¢å¼•

ç„¶åç»è¿‡ç¼–ç ä¹‹åï¼Œå°±æˆäº† AAAAA è¿™ç§ï¼Œè¿™ç§ç¼–ç æ–¹å¼å«åš **VLQ ç¼–ç **ã€‚

å„ç§è°ƒè¯•å·¥å…·ä¸€èˆ¬éƒ½æ”¯æŒ sourcemap çš„è§£æï¼Œåªè¦åœ¨æ–‡ä»¶æœ«å°¾åŠ ä¸Šè¿™æ ·ä¸€è¡Œï¼š

```js
//@ sourceMappingURL=/path/to/source.js.map
```

é™¤äº†è°ƒè¯•çš„æ—¶å€™ä¼šä½¿ç”¨ sourcemapï¼Œçº¿ä¸ŠæŠ¥é”™å®šä½æºç ä¹Ÿéœ€è¦ç”¨åˆ°ã€‚å¼€å‘æ—¶ä¼šä½¿ç”¨ sourcemap æ¥è°ƒè¯•ï¼Œä½†æ˜¯ç”Ÿäº§å¯ä¸ä¼šï¼Œä½†æ˜¯çº¿ä¸ŠæŠ¥é”™çš„æ—¶å€™ç¡®å®ä¹Ÿéœ€è¦å®šä½åˆ°æºç ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬éƒ½æ˜¯å•ç‹¬ä¸Šä¼  sourcemap åˆ°é”™è¯¯æ”¶é›†å¹³å°ã€‚

æ¯”å¦‚ sentry å°±æä¾›äº†ä¸€ä¸ª [@sentry/webpack-plugin](https://github.com/getsentry/sentry-webpack-plugin) æ”¯æŒåœ¨æ‰“åŒ…å®ŒæˆåæŠŠ sourcemap è‡ªåŠ¨ä¸Šä¼ åˆ° sentry åå°ï¼Œç„¶åæŠŠæœ¬åœ° sourcemap åˆ æ‰ã€‚è¿˜æä¾›äº† [@sentry/cli](https://github.com/getsentry/sentry-cli) è®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ä¸Šä¼ ã€‚

sourcemap åªæ˜¯ä½ç½®çš„æ˜ å°„ï¼Œå¯ä»¥ç”¨åœ¨ä»»ä½•ä»£ç ä¸Šï¼Œæ¯”å¦‚ JSã€TSã€CSS ç­‰ï¼Œè€Œä¸” TS çš„ç±»å‹ä¹Ÿæ”¯æŒ sourcemapï¼š

```json
{
  "compilerOptions": {
    "sourceMap": true,
    "outDir": "./out",
    "declaration": true,
    "declarationMap": true
  }
}
```

æŒ‡å®šäº† declaration ä¼šç”Ÿæˆ d.ts çš„å£°æ˜æ–‡ä»¶ï¼Œè¿˜å¯ä»¥æŒ‡å®š declarationMap æ¥ç”Ÿæˆ sourcemapã€‚è¿™æ ·åœ¨ VSCode é‡Œå°±å¯ä»¥ç›´æ¥ç‚¹å‡»æŸä¸ªç±»å‹æ¥è·³è½¬åˆ°æºç é‡Œå¯¹åº”çš„åœ°æ–¹äº†ã€‚è¿™ä¹Ÿç®— sourcemap åº”ç”¨çš„å¦ä¸€ä¸ªåœºæ™¯ï¼Œ_ç”¨äºç”Ÿæˆçš„ç±»å‹å’Œæºç ä¸­å®šä¹‰çš„å…³è”_ã€‚

#### 4.5.2 sourcemap çš„ç”Ÿæˆ

ç¼–è¯‘å·¥å…·åœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™ä¹Ÿä¼šç”Ÿæˆ sourcemapï¼š

![sourcemap çš„ç”Ÿæˆ](./image/sourcemap%20%E7%9A%84%E7%94%9F%E6%88%90.webp)

sourcemap å°±æ˜¯ç”±ä¸€ä¸ªä¸ªä½ç½®çš„æ˜ å°„ç»„æˆçš„ï¼Œå…³é”®å°±æ˜¯è¦çŸ¥é“æºç çš„å“ªä¸ªä½ç½®å¯¹åº”åˆ°äº†ç¼–è¯‘åä»£ç çš„å“ªä¸ªä½ç½®ï¼šé€šè¿‡ [astexplorer.net](https://astexplorer.net/#/gist/19042bfa06784d0e1b2dcb2ecd3559d5/50898c658d8129dbe520cc515af169331082036b) å¯ä»¥çœ‹åˆ°ï¼ŒAST ä¸­ä¿ç•™äº†æºç ä¸­çš„ä½ç½®ï¼Œè¿™æ˜¯ parser åœ¨ parse æºç çš„æ—¶å€™è®°å½•çš„ã€‚

![ASTä¸­çš„æ˜ å°„](./image/AST%E4%B8%AD%E7%9A%84%E6%98%A0%E5%B0%84.webp)

ç„¶åè¿›è¡Œ AST çš„å„ç§è½¬æ¢ä¹‹åä¼šæ‰“å°æˆç›®æ ‡ä»£ç ï¼Œæ‰“å°çš„æ—¶å€™æ˜¯ä¸€è¡Œè¡Œä¸€åˆ—åˆ—çš„æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å€™å°±æœ‰äº†ç›®æ ‡ä»£ç ä¸­çš„ä½ç½®ã€‚

```ts
export function ConditionaLExpression(node: Object) {
  this.print(node.test, node);
  this.space();
  this.token('?');
  this.space();
  this.print(node.consequent, node);
  this.space();
  this.token(':');
  this.space();
  this.print(node.alternate, node);
}
```

è¿™ä¸¤ä¸ªä½ç½®ä¸€å…³è”ï¼Œå°±æ˜¯ä¸€ä¸ª mappingã€‚

![sourcemapçš„ç”Ÿæˆè¿‡ç¨‹](./image/sourcemap%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B.webp)

è¿™æ ·å°±ç”Ÿæˆäº† sourcemapã€‚å½“ç„¶ sourcemap æœ‰å¯¹åº”çš„æ ¼å¼å’Œç¼–ç ï¼Œè‡ªå·±ç”Ÿæˆè¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œä¸€èˆ¬ä¼šç”¨ [source-map](https://github.com/mozilla/source-map) è¿™ä¸ªåŒ…ï¼šsource-map å¯ä»¥ç”¨äºç”Ÿæˆå’Œè§£æ sourcemapï¼Œå®ƒæš´éœ²äº† SourceMapConsumerã€SourceMapGeneratorã€SourceNode 3 ä¸ªç±»ï¼Œåˆ†åˆ«ç”¨äºæ¶ˆè´¹ sourcemapã€ç”Ÿæˆ sourcemapã€åˆ›å»ºæºç èŠ‚ç‚¹ã€‚

ç”Ÿæˆ sourcemap çš„æµç¨‹æ˜¯ï¼š

1. åˆ›å»ºä¸€ä¸ª SourceMapGenerator å¯¹è±¡
2. é€šè¿‡ addMapping æ–¹æ³•æ·»åŠ ä¸€ä¸ªæ˜ å°„
3. é€šè¿‡ toString è½¬ä¸º sourcemap å­—ç¬¦ä¸²

```js
let map = new SourceMapGenerator({
  file: 'source-mapped.js'
});

map.addMapping({
  generated: {
    line: 10,
    column: 35
  },
  source: 'foo.js',
  original: {
    line: 33,
    column: 2
  },
  name: 'christopher'
});

console.log(map.toString());
// '{"version":3,"file":"source-mapped.js",
//   "sources":["foo.js"],"names":["christopher"],"mappings":";;;;;;;;;mCAgCEA"}'
```

æ¶ˆè´¹ sourcemap ç”¨ `SourceMapConsumer` çš„ apiã€‚å¯ä»¥è°ƒç”¨ `originalPositionFor` å’Œ `generatedPositionFor` åˆ†åˆ«ç”¨ç›®æ ‡ä»£ç ä½ç½®æŸ¥æºç ä½ç½®å’Œç”¨æºç ä½ç½®æŸ¥ç›®æ ‡ä»£ç ä½ç½®ã€‚è¿˜å¯ä»¥é€šè¿‡ `eachMapping` éå†æ‰€æœ‰ mappingï¼Œå¯¹æ¯ä¸ªè¿›è¡Œå¤„ç†ã€‚

```js
const rawSourceMap = {
  version: 3,
  file: 'min.js',
  names: ['bar', 'baz', 'n'],
  sources: ['one.js', 'two.js'],
  sourceRoot: 'http://example.com/www/js/',
  mappings: 'CAAC,IAAI,IAAM,SAAUA,GAClB,OAAOC,IAAID;CCDb,IAAI,IAAM,SAAUE,GAClB,OAAOA'
};

const whatever = await SourceMapConsumer.with(rawSourceMap, null, consumer => {
  // ç›®æ ‡ä»£ç ä½ç½®æŸ¥è¯¢æºç ä½ç½®
  consumer.originalPositionFor({
    line: 2,
    column: 28
  });
  // { source: 'http://example.com/www/js/two.js',
  //   line: 2,
  //   column: 10,
  //   name: 'n' }

  // æºç ä½ç½®æŸ¥è¯¢ç›®æ ‡ä»£ç ä½ç½®
  consumer.generatedPositionFor({
    source: 'http://example.com/www/js/two.js',
    line: 2,
    column: 10
  });
  // { line: 2, column: 28 }

  // éå† mapping
  consumer.eachMapping(function (m) {
    // ...
  });

  return computeWhatever();
});
```

#### 4.5.3 webpack çš„ sourcemap é…ç½®

webpack å¯¹ sourcemap åšäº†å¾ˆå¤šå°è£…ã€‚æ¯”å¦‚ï¼š

- eval-nosources-cheap-module-source-map
- hidden-source-map

webpack çš„é…ç½®æ˜¯æœ‰è§„å¾‹çš„ã€‚å½“é…ç½®å†™é”™çš„æ—¶å€™ï¼Œwebpack ä¼šæç¤ºä¸€ä¸ªæ­£åˆ™ï¼š`^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$`ã€‚è¿™ä¸ªå°±æ˜¯é…ç½®çš„è§„å¾‹ï¼Œæ˜¯å‡ ç§åŸºç¡€é…ç½®çš„ç»„åˆã€‚ææ‡‚äº†æ¯ä¸€ç§åŸºç¡€é…ç½®ï¼Œæ¯”å¦‚ evalã€nosourcesã€cheapã€moduleï¼ŒæŒ‰ç…§è§„å¾‹ç»„åˆèµ·æ¥ï¼Œä¹Ÿå°±ææ‡‚äº†æ•´ä½“çš„é…ç½®ã€‚

- `eval`

  eval() å‡½æ•°ä¼šå°†ä¼ å…¥çš„å­—ç¬¦ä¸²å½“åš JS ä»£ç è¿›è¡Œæ‰§è¡Œã€‚ä½†æœ‰ä¸ªé—®é¢˜ï¼Œeval çš„ä»£ç æ‰“ä¸äº†æ–­ç‚¹ã€‚æ‰€ä»¥æµè§ˆå™¨æ”¯æŒäº†è¿™æ ·ä¸€ç§ç‰¹æ€§ï¼Œåªè¦åœ¨ eval ä»£ç çš„æœ€ååŠ ä¸Š `//# sourceURL=xxx`ï¼Œé‚£å°±ä¼šä»¥ xxx ä¸ºåå­—æŠŠè¿™æ®µä»£ç åŠ åˆ° sources é‡Œã€‚è¿™å°±å¯ä»¥æ‰“æ–­ç‚¹äº†ã€‚

  ```js
  eval(`
  function add(a,b){
    return a + b;
  }
  console.log(add(1, 2));
  //# sourceURL=å…‰.js`);
  // 3
  ```

  æ‰§è¡Œä»¥åï¼Œä¼šå‘ç° sources å¤šäº†å…‰.js çš„æ–‡ä»¶ï¼š

  ![eval()çš„sourceURL](<./image/eval()çš„sourceURL.webp>)

  å®ƒæ˜¯å¯ä»¥æ‰“æ–­ç‚¹çš„ï¼Œæ¯”å¦‚åœ¨ add é‡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶åå†æ‰§è¡Œ evalã€‚

  é™¤äº†æŒ‡å®š source æ–‡ä»¶å¤–ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥æŒ‡å®š sourcemap æ¥æ˜ å°„åˆ°æºç ï¼š

  ```js
  eval(`
  function add(a,b){
    return a + b;
  }
  console.log(add(1, 2));
  //# sourceURL=å…‰.js
  //# sourceMappingURL= xxx`);
  ```

  è¿™æ ·ï¼ŒåŠ¨æ€ eval çš„ä»£ç ä¹Ÿèƒ½å…³è”åˆ°æºç ï¼Œå¹¶ä¸”èƒ½æ‰“æ–­ç‚¹äº†ã€‚

  webpack å°±åˆ©ç”¨äº† eval è¿™ä¸ªç‰¹æ€§æ¥ä¼˜åŒ–çš„ sourcemap ç”Ÿæˆçš„æ€§èƒ½ï¼Œæ¯”å¦‚å¯ä»¥æŒ‡å®š `devtool` ä¸º evalï¼š

  ```js
  module.exports = {
    devtool: 'eval'
  };
  ```

  ç”Ÿæˆçš„ä»£ç å°±æ˜¯æ¯ä¸ªæ¨¡å—éƒ½è¢« eval åŒ…è£¹çš„ï¼Œå¹¶ä¸”æœ‰ sourceUrl æ¥æŒ‡å®šæ–‡ä»¶åï¼š

  ![devtoolå€¼ä¸ºevalæ—¶ç”Ÿæˆçš„ä»£ç ](./image/devtool%E5%80%BC%E4%B8%BAeval%E6%97%B6%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81.webp)

  è¿™æ ·åšæ¯”è¾ƒå¿«ï¼Œå› ä¸ºåªè¦æŒ‡å®šæ–‡ä»¶åå°±è¡Œï¼Œä¸ç”¨ç”Ÿæˆ sourcemapã€‚sourcemap çš„ç”Ÿæˆè¿˜æ˜¯å¾ˆæ…¢çš„ï¼Œè¦ä¸€ä¸ªä¸ª mapping çš„å¤„ç†ï¼Œåšç¼–ç ä¹‹ç±»çš„ã€‚

  æ¯ä¸ªæ¨¡å—çš„ä»£ç éƒ½è¢« eval åŒ…è£¹ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™å°±ä¼šåœ¨ sources é‡Œç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥æ‰“æ–­ç‚¹äº†ã€‚ä¸è¿‡è¿™æ ·åªæ˜¯æŠŠæ¯ä¸ªæ¨¡å—çš„ä»£ç åˆ†äº†å‡ºå»ï¼Œå¹¶æ²¡æœ‰åšæºç çš„å…³è”ï¼Œå¦‚æœç›¸å…³è”æºç ï¼Œå¯ä»¥å†å¼€å¯ sourcemapï¼š

  ```js
  module.exports = {
    devtool: 'eval-source-map'
  };
  ```

  ä¼šå‘ç°ç”Ÿæˆçš„ä»£ç ä¹Ÿæ˜¯ç”¨ eval åŒ…è£¹çš„ï¼Œä½†é™¤äº† sourceUrl å¤–ï¼Œè¿˜æœ‰ sourceMappingUrlï¼š

  ![devtoolå€¼ä¸ºeval-source-mapæ—¶ç”Ÿæˆçš„ä»£ç ](./image/devtool%E5%80%BC%E4%B8%BAeval-source-map%E6%97%B6%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81.webp)

  å†è¿è¡Œçš„æ—¶å€™é™¤äº† eval çš„ä»£ç ä¼šç”Ÿæˆæ–‡ä»¶æ”¾åœ¨ sources å¤–ï¼Œè¿˜ä¼šåš sourcemap çš„æ˜ å°„ï¼š

- `source-map`

  source-map çš„é…ç½®æ˜¯ç”Ÿæˆç‹¬ç«‹çš„ sourcemap æ–‡ä»¶ã€‚

  ```js
  module.exports = {
    devtool: 'source-map'
  };
  ```

  ![source-mapç”Ÿæˆçš„æ–‡ä»¶](./image/source-map%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E4%BB%B6.webp)

  å¯ä»¥å…³è”ï¼Œä¹Ÿå¯ä»¥ä¸å…³è”ï¼Œæ¯”å¦‚åŠ ä¸Š hiddenï¼Œå°±æ˜¯ç”Ÿæˆ sourcemap ä½†æ˜¯ä¸å…³è”ï¼š

  ```js
  module.exports = {
    devtool: 'hidden-source-map'
  };
  ```

  ç”Ÿäº§ç¯å¢ƒå°±ä¸éœ€è¦å…³è” sourcemapï¼Œä½†æ˜¯å¯èƒ½è¦ç”Ÿæˆ sourcemap æ–‡ä»¶ï¼ŒæŠŠå®ƒä¸Šä¼ åˆ°é”™è¯¯ç®¡ç†å¹³å°ä¹‹ç±»çš„ï¼Œç”¨æ¥æ˜ å°„çº¿ä¸Šä»£ç æŠ¥é”™ä½ç½®åˆ°å¯¹åº”çš„æºç ã€‚

  æ­¤å¤–ï¼Œè¿˜å¯ä»¥é…ç½®æˆ inline çš„ï¼š

  ```js
  module.exports = {
    devtool: 'inline-source-map'
  };
  ```

  è¿™ä¸ªå°±æ˜¯é€šè¿‡ dataUrl çš„æ–¹å¼å†…è”åœ¨æ‰“åŒ…åçš„æ–‡ä»¶é‡Œï¼š

  ![inline-source-mapç”Ÿæˆçš„æ–‡ä»¶](./image/inline-source-map%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E4%BB%B6.webp)

- `cheap`

  sourcemap æ…¢ä¸»è¦æ˜¯å¤„ç†æ˜ å°„æ¯”è¾ƒæ…¢ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¹¶ä¸éœ€è¦æ˜ å°„åˆ°æºç çš„è¡Œå’Œåˆ—ï¼Œåªè¦ç²¾ç¡®åˆ°è¡Œå°±è¡Œï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨ cheapã€‚

- `module`

  webpack ä¸­å¯¹ä¸€ä¸ªæ¨¡å—ä¼šè¿›è¡Œå¤šæ¬¡å¤„ç†ï¼Œæ¯”å¦‚ç»è¿‡ loader A åšä¸€æ¬¡è½¬æ¢ï¼Œå†ç”¨ loader B åšä¸€æ¬¡è½¬æ¢ï¼Œä¹‹åæ‰“åŒ…åˆ°ä¸€èµ·ã€‚æ¯æ¬¡è½¬æ¢éƒ½ä¼šç”Ÿæˆ sourcemapï¼Œé‚£ä¹Ÿå°±æ˜¯æœ‰å¤šä¸ª sourcemapï¼š

  ![webpackå¤šæ¬¡è½¬æ¢](./image/webpack%E5%A4%9A%E6%AC%A1%E8%BD%AC%E6%8D%A2.webp)

  é»˜è®¤ sourcemap åªæ˜¯èƒ½ä» bundle å…³è”åˆ°æ¨¡å—çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯åªå…³è”äº†æœ€åé‚£ä¸ª sourcemapã€‚

  ![é»˜è®¤sourcemapå…³è”ç›®æ ‡ä»£ç ](./image/%E9%BB%98%E8%AE%A4sourcemap%E5%85%B3%E8%81%94%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81.webp)

  å¦‚æœæƒ³è°ƒè¯•æœ€åˆçš„æºç ï¼Œé‚£å°±æŠŠæ¯ä¸€æ¬¡çš„ loader çš„ sourcemap ä¹Ÿå…³è”èµ·æ¥ï¼Œè¿™å°±æ˜¯ module é…ç½®çš„ä½œç”¨ã€‚è¿™æ ·å°±èƒ½ä¸€æ¬¡æ€§æ˜ å°„å›æœ€åˆçš„æºç ï¼š

  ![sourcemapçš„module](./image/sourcemap%E7%9A%84module.webp)

- `nosources`

  sourcemap é‡Œæ˜¯æœ‰ sourceContent éƒ¨åˆ†çš„ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æŠŠæºç è´´åœ¨è¿™é‡Œï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ ¹æ®æ–‡ä»¶è·¯å¾„æŸ¥ä¸åˆ°æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜ å°„ï¼Œä½†è¿™æ ·ä¼šå¢åŠ  sourcemap çš„ä½“ç§¯ã€‚å¦‚æœç¡®å®šæ ¹æ®æ–‡ä»¶è·¯å¾„èƒ½æŸ¥æ‰¾åˆ°æºæ–‡ä»¶ï¼Œé‚£ä¸ç”Ÿæˆ sourceContent ä¹Ÿè¡Œã€‚

  æ¯”å¦‚ devtool é…ç½®ä¸º source-mapï¼Œç”Ÿæˆçš„ sourcemap æ˜¯è¿™æ ·çš„ï¼š

  ![sourcemapç”Ÿæˆçš„æ–‡ä»¶ä¸­æœ‰sourceContent](./image/sourcemap%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%AD%E6%9C%89sourceContent.webp)

  å½“åŠ ä¸Š nosources ä¹‹åï¼Œç”Ÿæˆçš„ sourcemap å°±æ²¡æœ‰ sourceContent éƒ¨åˆ†äº†ï¼š

  ```js
  module.exports = {
    devtool: 'nosources-source-map'
  };
  ```

å¯ä»¥æ ¹æ®ä¸Šé¢çš„åŸºç¡€é…ç½®æ¥è‡ªç”±ç»„åˆï¼Œwebpack æ˜¯æŒ‰ç…§è¿™ä¸ªæ­£åˆ™æ¥æ ¡éªŒ devtool çš„ï¼š`^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$`ã€‚

webpack æœ‰è¿™æ ·ä¸€ä¸ªæ’ä»¶ [SourceMapDevToolPlugin](https://webpack.docschina.org/plugins/source-map-dev-tool-plugin)ï¼Œå®ƒæœ‰å¾ˆå¤š optionï¼Œæ¯”å¦‚ moduleã€columnsã€noSources ç­‰ï¼š

- `module = true (boolean)`ï¼šè¡¨ç¤º loader æ˜¯å¦ç”Ÿæˆ source mapã€‚
- `columns = true (boolean)`ï¼šè¡¨ç¤ºæ˜¯å¦åº”è¯¥ä½¿ç”¨ column mappingã€‚
- `noSources = false (boolean)`ï¼šé˜²æ­¢æºæ–‡ä»¶çš„å†…å®¹è¢«åŒ…å«åœ¨ source map ä¸­ã€‚

ç›¸å½“äºæ˜¯ devtool çš„å¦ä¸€ç§é…ç½®æ–¹å¼ï¼Œå¯ç”¨å®ƒéœ€è¦æŠŠ devtool è®¾ç½®ä¸º falseã€‚è€Œä¸”å®ƒå¯ä»¥æ§åˆ¶æ›´å¤šä¸œè¥¿ï¼Œæ¯”å¦‚ä¿®æ”¹ sourcemap çš„ url å’Œæ–‡ä»¶åç­‰ï¼š

```js
new webpack.SourceMapDevToolPlugin({
  append: '\n//# sourceMappingURL=https://example.com/sourcemap/[url]',
  filename: '[name].map'
});
```

å½“éœ€è¦åšæ›´å¤šçš„ sourcemap ç”Ÿæˆæ–¹å¼çš„æ§åˆ¶çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª webpack æ’ä»¶ã€‚
